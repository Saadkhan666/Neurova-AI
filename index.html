<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neurova OS | Saad Khan</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#131314', 900: '#0b0b0c', 950: '#000000' },
                        blue: { 500: '#a8c7fa', 600: '#1c6ef0' },
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' }
                }
            }
        }
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="h-full flex transition-colors duration-300">

    <div id="authGate" class="fixed inset-0 z-[100] bg-[#131314] flex flex-col items-center justify-center transition-all duration-700">
        <div class="relative w-full max-w-md p-8 text-center">
            <div class="w-24 h-24 mx-auto bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl flex items-center justify-center mb-8 shadow-2xl animate-float">
                <i class="fa-solid fa-brain text-white text-5xl"></i>
            </div>
            <h1 class="text-4xl font-bold mb-2 text-white">Neurova OS</h1>
            <p class="text-gray-400 mb-10 text-sm">Created by Saad Khan</p>

            <button id="googleBtn" onclick="app.auth.signIn()" class="w-full bg-[#1e1f20] hover:bg-[#2d2e30] border border-gray-700 text-white font-medium py-4 px-6 rounded-full flex items-center justify-center gap-3 transition-all shadow-lg">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                <span>Sign in with Google</span>
            </button>
            
            <p id="errorMsg" class="text-red-400 text-xs mt-4 hidden"></p>

            <button onclick="app.auth.guest()" class="mt-6 text-xs text-gray-500 hover:text-white transition underline">
                Continue as Guest (Offline Mode)
            </button>
        </div>
    </div>

    <div id="appContainer" class="flex-1 flex h-full opacity-0 transition-opacity duration-1000 pointer-events-none">
        
        <aside class="w-72 bg-[#0b0b0c] border-r border-[#1e1f20] flex flex-col hidden md:flex shrink-0">
            <div class="p-5 flex items-center justify-between">
                <div class="font-bold text-lg text-white">Neurova</div>
                <button onclick="app.ui.toggleSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-cog"></i></button>
            </div>
            <div class="px-4 mb-4">
                <button onclick="app.chat.new()" class="w-full bg-[#1e1f20] hover:bg-[#2c2d30] text-gray-200 rounded-full py-3 text-sm font-medium flex items-center gap-3 px-4 transition">
                    <i class="fa-solid fa-plus text-gray-400"></i> New chat
                </button>
            </div>
            <div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-1"></div>
            
            <div class="p-4 border-t border-[#1e1f20] flex items-center gap-3">
                <img id="userAvatar" class="w-8 h-8 rounded-full bg-gray-700 object-cover">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-medium truncate text-white">Guest</p>
                    <button onclick="app.auth.logout()" class="text-[10px] text-gray-500 hover:text-red-400">Sign Out</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative min-w-0 bg-[#131314]">
            <header class="md:hidden h-16 flex items-center justify-between px-4 sticky top-0 bg-[#131314]/90 backdrop-blur z-20">
                <span class="font-bold text-lg text-white">Neurova</span>
                <div class="flex gap-4">
                    <button onclick="app.ui.toggleCanvas(true)"><i class="fa-solid fa-code text-gray-400"></i></button>
                    <button onclick="app.ui.toggleSettings()"><i class="fa-solid fa-bars text-gray-400"></i></button>
                </div>
            </header>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth">
                <div id="welcome" class="h-full flex flex-col items-center justify-center text-center pb-20">
                    <div class="text-3xl mb-2 font-bold text-white">Hello, I am Neurova.</div>
                    <p class="text-gray-500 text-sm">Engineered by Saad Khan</p>
                </div>
            </div>

            <div class="p-4 md:pb-6 max-w-4xl mx-auto w-full z-20 relative">
                <div id="previewDock" class="hidden flex gap-2 p-2 mb-2 bg-[#1e1f20] rounded-xl border border-gray-800 w-max max-w-full overflow-x-auto"></div>
                <div class="relative bg-[#1e1f20] rounded-[2rem] border border-gray-700 focus-within:border-gray-500 transition-all shadow-lg">
                    <textarea id="userInput" rows="1" class="w-full bg-transparent border-none text-gray-200 px-6 py-4 pr-32 focus:ring-0 resize-none max-h-48" placeholder="Ask Saad's AI..."></textarea>
                    
                    <div class="absolute right-3 bottom-2 flex items-center gap-2">
                        <button onclick="document.getElementById('fileUpload').click()" class="p-2 text-gray-400 hover:text-white transition"><i class="fa-regular fa-image"></i></button>
                        <input type="file" id="fileUpload" class="hidden" accept="image/*" multiple onchange="app.files.handle(this)">
                        <button onclick="app.chat.send()" id="sendBtn" class="bg-white text-black rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200 transition"><i class="fa-solid fa-arrow-up"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <aside id="canvasPanel" class="fixed inset-y-0 right-0 w-full md:w-[45%] bg-[#131314] border-l border-[#1e1f20] shadow-2xl z-40 transform translate-x-full flex flex-col">
            <div class="h-14 border-b border-[#1e1f20] flex items-center justify-between px-4 bg-[#0b0b0c]">
                <span class="font-bold text-xs uppercase tracking-wider text-gray-400">Artifact Preview</span>
                <button onclick="app.ui.toggleCanvas(false)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <iframe id="canvasFrame" class="flex-1 bg-white border-none"></iframe>
        </aside>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1e1f20] border border-gray-700 rounded-2xl w-full max-w-md p-6">
            <h2 class="font-bold mb-4 text-white">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">AI Model</label>
                    <select id="modelSelect" class="w-full bg-[#131314] text-white rounded-lg px-4 py-3 border border-gray-700 mt-1">
                        <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash (Fastest)</option>
                        <option value="deepseek/deepseek-r1:free">DeepSeek R1 (Deep Thinker)</option>
                    </select>
                </div>
                <div class="p-3 bg-blue-900/20 border border-blue-900/50 rounded-lg">
                    <p class="text-xs text-blue-200"><i class="fa-solid fa-check-circle mr-1"></i> Owner License Active (Saad Khan)</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="app.ui.toggleSettings()" class="text-gray-400 hover:text-white px-4">Close</button>
                <button onclick="app.ui.saveSettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-medium">Save</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ðŸ›‘ CONFIGURATION ZONE
         * PASTE YOUR KEYS HERE CAREFULLY
         */
        
        // 1. FIREBASE CONFIG (From Firebase Console)
        const firebaseConfig = {
Â Â apiKey: "AIzaSyCB5b4co_uTC2U7xP0gsJ90kXzG5y92XdA",
Â Â authDomain: "neurova-ai-6b79e.firebaseapp.com",
Â Â projectId: "neurova-ai-6b79e",
Â Â storageBucket: "neurova-ai-6b79e.firebasestorage.app",
Â Â messagingSenderId: "771416729770",
Â Â appId: "1:771416729770:web:8b781ed3d3845198cd88d3",
Â Â measurementId: "G-G3E38VSKM7"
};

        // 2. OPENROUTER API KEY (Your Secret Key)
        const OWNER_API_KEY = "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"; // <--- PASTE KEY HERE

        // ==========================================
        
        let auth, db;
        try {
            if(Object.keys(firebaseConfig).length > 0) {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                // Enable Remember Me
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            }
        } catch(e) { console.error(e); }

        const app = {
            data: { user: null, chats: [], activeId: null, settings: { model: 'google/gemini-2.0-flash-001' }, uploads: [] },
            
            // AUTHENTICATION LOGIC
            auth: {
                init() {
                    // 1. Check Local Storage (Fastest)
                    const localUser = localStorage.getItem('neurova_user');
                    if(localUser) this.success(JSON.parse(localUser));

                    // 2. Check Firebase (Secure)
                    if(auth) {
                        auth.onAuthStateChanged(user => {
                            if(user) {
                                localStorage.setItem('neurova_user', JSON.stringify(user));
                                this.success(user);
                            } else {
                                // If not logged in via Google, check for Guest Mode
                                if(!localStorage.getItem('neurova_guest')) {
                                    localStorage.removeItem('neurova_user');
                                }
                            }
                        });
                    }
                    
                    // 3. Check Guest Flag
                    if(localStorage.getItem('neurova_guest') && !localUser) this.guest();
                },
                signIn() {
                    if(!auth) {
                        document.getElementById('errorMsg').innerText = "Error: Firebase Config is empty in index.html";
                        document.getElementById('errorMsg').classList.remove('hidden');
                        return;
                    }
                    const btn = document.getElementById('googleBtn');
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Signing in...';
                    
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider)
                        .then(res => this.success(res.user))
                        .catch(e => {
                            btn.innerHTML = 'Sign in with Google';
                            const errDiv = document.getElementById('errorMsg');
                            errDiv.innerText = "Login Failed: " + e.message;
                            errDiv.classList.remove('hidden');
                        });
                },
                guest() {
                    localStorage.setItem('neurova_guest', 'true');
                    this.success({ displayName: 'Guest', photoURL: 'https://cdn-icons-png.flaticon.com/512/149/149071.png', uid: 'guest' });
                },
                logout() {
                    if(auth) auth.signOut();
                    localStorage.removeItem('neurova_user');
                    localStorage.removeItem('neurova_guest');
                    location.reload();
                },
                success(user) {
                    app.data.user = user;
                    // Hide Login Gate
                    const gate = document.getElementById('authGate');
                    gate.style.opacity = '0';
                    setTimeout(() => gate.style.display = 'none', 700);
                    
                    // Show App
                    const container = document.getElementById('appContainer');
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    
                    // Update Profile
                    document.getElementById('userName').innerText = user.displayName || 'Guest';
                    if(user.photoURL) document.getElementById('userAvatar').src = user.photoURL;
                    
                    app.init();
                }
            },

            // MAIN APP LOGIC
            init() {
                const s = localStorage.getItem('neurova_data');
                if(s) { const p = JSON.parse(s); app.data.chats = p.chats||[]; app.data.settings = {...app.data.settings, ...p.settings}; }
                if(app.data.chats.length === 0) app.chat.new(false); else app.chat.load(app.data.chats[0].id);
                
                document.getElementById('userInput').addEventListener('keydown', e => { 
                    if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); app.chat.send(); } 
                });
                
                // Register Service Worker for PWA
                if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
            },

            save() { localStorage.setItem('neurova_data', JSON.stringify({ chats: app.data.chats, settings: app.data.settings })); },

            chat: {
                new(render=true) {
                    const c = { id: Date.now(), title: 'New Chat', messages: [] };
                    app.data.chats.unshift(c);
                    if(render) this.load(c.id);
                    app.ui.renderHistory();
                },
                load(id) {
                    app.data.activeId = id;
                    const c = app.data.chats.find(x => x.id == id);
                    const box = document.getElementById('chatContainer');
                    box.innerHTML = `<div id="welcome" class="${(!c || c.messages.length===0)?'flex':'hidden'} h-full flex-col items-center justify-center text-center opacity-50"><h1 class="text-3xl font-bold text-white">Neurova</h1><p class="text-sm mt-2">Created by Saad Khan</p></div>`;
                    if(c) c.messages.forEach(m => this.append(m));
                    app.ui.renderHistory();
                },
                append(msg, stream=false) {
                    const box = document.getElementById('chatContainer');
                    let div = stream ? document.getElementById('streamingMsg') : null;
                    if(!div) {
                        div = document.createElement('div');
                        if(stream) div.id = 'streamingMsg';
                        div.className = `w-full flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                        box.appendChild(div);
                    }
                    
                    let imgs = '';
                    if(msg.attachments?.length) imgs = `<div class="flex gap-2 mb-2 justify-end">${msg.attachments.map(u=>`<img src="${u}" class="w-32 rounded-lg border border-gray-700">`).join('')}</div>`;
                    
                    const text = msg.role === 'user' ? msg.content : DOMPurify.sanitize(marked.parse(msg.content));
                    div.innerHTML = `<div class="max-w-[85%] md:max-w-[75%] ${msg.role==='user'?'ml-auto':''}">${imgs}<div class="${msg.role==='user'?'msg-user p-4 text-sm':'msg-ai prose prose-invert max-w-none'}">${text}</div></div>`;
                    
                    if(msg.role !== 'user') div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                    box.scrollTop = box.scrollHeight;
                },
                async send() {
                    const input = document.getElementById('userInput');
                    const text = input.value.trim();
                    const uploads = app.data.uploads;
                    if(!text && !uploads.length) return;

                    input.value = '';
                    app.data.uploads = [];
                    app.ui.renderDock();
                    document.getElementById('welcome').classList.add('hidden');

                    const c = app.data.chats.find(x => x.id == app.data.activeId);
                    const userMsg = { role: 'user', content: text, attachments: uploads.map(u=>u.content) };
                    c.messages.push(userMsg);
                    if(c.messages.length === 1) c.title = text.slice(0, 20);
                    this.append(userMsg);
                    app.save();

                    // SAAD KHAN SYSTEM PROMPT
                    const systemPrompt = "You are Neurova, an advanced AI created by Saad Khan. If asked about your creator, answer 'Saad Khan'. Be concise, helpful, and intelligent.";

                    const history = c.messages.map(m => {
                        if(m.attachments?.length) return { role: m.role, content: [{type:'text', text:m.content}, ...m.attachments.map(u=>({type:'image_url', image_url:{url:u}}))] };
                        return { role: m.role, content: m.content };
                    });
                    history.unshift({ role: 'system', content: systemPrompt });

                    try {
                        this.append({ role: 'assistant', content: 'â—' }, true);
                        
                        // STREAMING REQUEST
                        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${OWNER_API_KEY}`, "Content-Type": "application/json" },
                            body: JSON.stringify({
                                model: app.data.settings.model,
                                messages: history,
                                stream: true
                            })
                        });

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let aiText = "";
                        
                        while(true) {
                            const { done, value } = await reader.read();
                            if(done) break;
                            const chunk = decoder.decode(value);
                            chunk.split('\n').forEach(line => {
                                if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                                    try { 
                                        const json = JSON.parse(line.slice(6));
                                        const content = json.choices[0].delta.content || "";
                                        aiText += content;
                                        this.append({ role:'assistant', content: aiText }, true);
                                    } catch(e){}
                                }
                            });
                        }

                        document.getElementById('streamingMsg').removeAttribute('id');
                        c.messages.push({ role: 'assistant', content: aiText });
                        app.save();

                        // Canvas Check
                        if(aiText.includes('```html')) {
                            const code = aiText.match(/```html([\s\S]*?)```/)[1];
                            document.getElementById('canvasFrame').srcdoc = code;
                            app.ui.toggleCanvas(true);
                        }

                    } catch(e) { 
                        alert("API Error: " + e.message);
                        // Clean up loading state if error
                        const loader = document.getElementById('streamingMsg');
                        if(loader) loader.innerHTML = "<span class='text-red-400'>Error generating response.</span>";
                    }
                }
            },
            files: {
                handle(input) {
                    Array.from(input.files).forEach(f => {
                        const r = new FileReader();
                        r.onload = e => { app.data.uploads.push({ type: 'img', content: e.target.result }); app.ui.renderDock(); };
                        r.readAsDataURL(f);
                    });
                }
            },
            ui: {
                toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); },
                saveSettings() { app.data.settings.model = document.getElementById('modelSelect').value; app.save(); this.toggleSettings(); },
                renderHistory() {
                    const l = document.getElementById('chatList'); l.innerHTML = '';
                    app.data.chats.forEach(c => {
                        const d = document.createElement('div');
                        d.className = `p-2 rounded cursor-pointer truncate text-sm mb-1 ${c.id==app.data.activeId ? 'bg-[#282a2c] text-blue-400' : 'text-gray-400 hover:text-white'}`;
                        d.innerText = c.title; d.onclick = () => app.chat.load(c.id);
                        l.appendChild(d);
                    });
                },
                renderDock() {
                    const d = document.getElementById('previewDock');
                    d.classList.toggle('hidden', !app.data.uploads.length);
                    d.innerHTML = app.data.uploads.map(u => `<img src="${u.content}" class="h-12 w-12 rounded border border-gray-600">`).join('');
                },
                toggleCanvas(s) {
                    const p = document.getElementById('canvasPanel');
                    p.parentElement.classList.toggle('canvas-open', s);
                }
            }
        };
        window.onload = () => app.auth.init();
    </script>
</body>
</html>
