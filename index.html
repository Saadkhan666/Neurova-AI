<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neurova OS | Cloud Sync</title>
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1a1d21', 900: '#111316', 950: '#0b0c0e' },
                        blue: { 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .glass { background: rgba(0, 0, 0, 0.2); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        #canvasPanel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .canvas-open #canvasPanel { transform: translateX(0); }
    </style>
</head>
<body class="bg-white dark:bg-gray-950 text-gray-800 dark:text-gray-100 h-full flex transition-colors duration-300">

    <div id="authGate" class="fixed inset-0 z-[100] bg-white dark:bg-gray-950 flex flex-col items-center justify-center transition-all duration-700">
        <div class="relative w-full max-w-md p-8 text-center">
            <div class="w-24 h-24 mx-auto bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-blue-500/20 animate-float">
                <i class="fa-solid fa-brain text-white text-5xl"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 tracking-tight">Neurova Cloud</h1>
            <p class="text-gray-400 mb-8">Syncs across all your devices</p>

            <button onclick="app.auth.signIn()" class="w-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-white font-medium py-3.5 px-4 rounded-xl flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-xl group">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 group-hover:scale-110 transition-transform">
                <span>Sign in with Google</span>
            </button>
            
            <div class="mt-6 text-xs text-gray-400">
                <button onclick="app.auth.guest()" class="mt-4 underline hover:text-blue-500">Or use offline (No Sync)</button>
            </div>
        </div>
    </div>

    <div id="appContainer" class="flex-1 flex h-full opacity-0 transition-opacity duration-1000 pointer-events-none">
        
        <aside class="w-72 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col hidden md:flex shrink-0">
            <div class="p-4 h-16 border-b border-gray-200 dark:border-gray-800 flex items-center gap-3">
                <img id="userAvatar" src="" class="w-8 h-8 rounded-full bg-gray-300 object-cover hidden">
                <div class="flex-1 min-w-0">
                    <h3 id="userName" class="font-bold text-sm truncate">Guest</h3>
                    <p id="userEmail" class="text-[10px] text-gray-500 truncate">Local</p>
                </div>
                <button onclick="app.auth.logout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-sign-out"></i></button>
            </div>
            <div class="p-3">
                <button onclick="app.chat.new()" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-2.5 text-sm font-medium shadow-md transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>
            <div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-1 py-2"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-800 grid grid-cols-2 gap-2">
                <button onclick="app.ui.toggleSettings()" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 text-xs flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cog"></i> Settings
                </button>
                <button onclick="app.ui.toggleTheme()" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 text-xs flex items-center justify-center gap-2">
                    <i id="themeIcon" class="fa-solid fa-moon"></i> Theme
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative min-w-0 bg-white dark:bg-gray-950">
            <header class="md:hidden h-14 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 bg-white/80 dark:bg-gray-950/80 backdrop-blur sticky top-0 z-20">
                <div class="font-bold flex items-center gap-2 text-blue-600"><i class="fa-solid fa-brain"></i> Neurova</div>
                <button onclick="app.ui.toggleCanvas(true)" class="text-gray-500"><i class="fa-solid fa-code"></i></button>
            </header>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                <div id="welcome" class="h-full flex flex-col items-center justify-center text-center">
                    <div class="w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-3xl flex items-center justify-center mb-6 animate-pulse">
                        <i class="fa-solid fa-cloud text-3xl text-blue-500"></i>
                    </div>
                    <h1 class="text-2xl font-bold">Cloud Sync Active</h1>
                    <p class="text-gray-400 text-sm mt-2">Your settings and API keys are now synced.</p>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-gray-950 z-20">
                <div class="max-w-3xl mx-auto relative group">
                    <div id="previewDock" class="hidden flex gap-2 p-2 mb-2 overflow-x-auto bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800"></div>
                    <div class="relative bg-gray-100 dark:bg-gray-900 rounded-2xl border border-transparent focus-within:border-blue-500 transition-colors">
                        <textarea id="userInput" rows="1" class="w-full bg-transparent border-none px-4 py-3 pr-32 focus:ring-0 resize-none max-h-40" placeholder="Ask Neurova..."></textarea>
                        <div class="absolute right-2 bottom-2 flex items-center gap-1">
                            <button onclick="app.chat.toggleWeb()" id="webBtn" class="p-2 text-gray-400 hover:text-green-500 rounded-full transition"><i class="fa-solid fa-globe"></i></button>
                            <button onclick="document.getElementById('fileUpload').click()" class="p-2 text-gray-400 hover:text-blue-500 rounded-full transition"><i class="fa-solid fa-paperclip"></i></button>
                            <input type="file" id="fileUpload" class="hidden" multiple onchange="app.files.handle(this)">
                            <button onclick="app.chat.send()" id="sendBtn" class="bg-blue-600 text-white rounded-xl w-8 h-8 flex items-center justify-center shadow-lg"><i class="fa-solid fa-arrow-up text-sm"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside id="canvasPanel" class="fixed inset-y-0 right-0 w-full md:w-[45%] bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 shadow-2xl z-40 transform translate-x-full flex flex-col">
            <div class="h-14 border-b flex items-center justify-between px-4 bg-gray-50 dark:bg-gray-900">
                <span class="font-bold text-xs uppercase tracking-wider">Holo-Canvas</span>
                <button onclick="app.ui.toggleCanvas(false)" class="text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <iframe id="canvasFrame" class="flex-1 bg-white border-none"></iframe>
        </aside>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-md p-6">
            <h2 class="font-bold mb-4">Settings (Synced)</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold">OpenRouter API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2 mt-1" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold">Model ID</label>
                    <input type="text" id="modelInput" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2 mt-1" value="deepseek/deepseek-r1:free">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold">System Prompt</label>
                    <textarea id="sysPromptInput" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2 h-24 mt-1" placeholder="System Prompt..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="app.ui.toggleSettings()" class="text-gray-500 px-4">Cancel</button>
                <button onclick="app.ui.saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save & Sync</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ðŸ›‘ PASTE FIREBASE CONFIG HERE
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyCB5b4co_uTC2U7xP0gsJ90kXzG5y92XdA",
  authDomain: "neurova-ai-6b79e.firebaseapp.com",
  projectId: "neurova-ai-6b79e",
  storageBucket: "neurova-ai-6b79e.firebasestorage.app",
  messagingSenderId: "771416729770",
  appId: "1:771416729770:web:8b781ed3d3845198cd88d3",
  measurementId: "G-G3E38VSKM7"
};

        let auth = null, db = null;
        try {
            if(Object.keys(firebaseConfig).length > 0) {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch(e) { console.error("Firebase Init Error", e); }

        const app = {
            data: {
                user: null, chats: [], activeId: null,
                settings: { apiKey: '', model: 'deepseek/deepseek-r1:free', sysPrompt: 'You are Neurova.', theme: 'dark' },
                webMode: false, uploads: []
            },

            // --- SYNC MODULE (NEW) ---
            sync: {
                async pull(uid) {
                    if(!db) return;
                    try {
                        const doc = await db.collection('users').doc(uid).get();
                        if(doc.exists) {
                            const data = doc.data();
                            app.data.settings = { ...app.data.settings, ...data.settings };
                            console.log("Settings Pulled from Cloud");
                            // Update Inputs
                            document.getElementById('apiKeyInput').value = app.data.settings.apiKey || '';
                            document.getElementById('modelInput').value = app.data.settings.model;
                            document.getElementById('sysPromptInput').value = app.data.settings.sysPrompt;
                        }
                    } catch(e) { console.error("Sync Error", e); }
                },
                async push() {
                    if(!db || !app.data.user) return;
                    try {
                        await db.collection('users').doc(app.data.user.uid).set({
                            settings: app.data.settings,
                            updatedAt: new Date()
                        }, { merge: true });
                        console.log("Settings Pushed to Cloud");
                    } catch(e) { console.error("Sync Push Error", e); }
                }
            },

            auth: {
                init() {
                    if(auth) {
                        auth.onAuthStateChanged((user) => {
                            if (user) this.onLoginSuccess(user);
                            else if(localStorage.getItem('neurova_guest')) this.guest();
                        });
                    } else if(localStorage.getItem('neurova_guest')) this.guest();
                },
                signIn() {
                    if(!auth) { alert("Config Missing!"); return; }
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).then((r) => this.onLoginSuccess(r.user)).catch((e) => alert(e.message));
                },
                guest() {
                    localStorage.setItem('neurova_guest', 'true');
                    this.onLoginSuccess({ displayName: 'Guest User', photoURL: null, email: 'Local Session', uid: null });
                },
                logout() {
                    if(auth) auth.signOut();
                    localStorage.removeItem('neurova_guest');
                    location.reload();
                },
                onLoginSuccess(user) {
                    app.data.user = user;
                    const gate = document.getElementById('authGate');
                    const cont = document.getElementById('appContainer');
                    gate.style.opacity = '0';
                    setTimeout(() => gate.style.display = 'none', 700);
                    cont.style.opacity = '1';
                    cont.style.pointerEvents = 'auto';
                    document.getElementById('userName').innerText = user.displayName;
                    document.getElementById('userEmail').innerText = user.email;
                    if(user.photoURL) {
                        document.getElementById('userAvatar').src = user.photoURL;
                        document.getElementById('userAvatar').classList.remove('hidden');
                    }
                    
                    // Trigger Cloud Sync if logged in
                    if(user.uid) {
                        app.sync.pull(user.uid).then(() => app.init());
                    } else {
                        app.init();
                    }
                }
            },

            init() {
                this.loadStorage(); // Load local first
                this.ui.applyTheme();
                
                // If inputs empty, populate from data
                if(!document.getElementById('apiKeyInput').value) 
                     document.getElementById('apiKeyInput').value = this.data.settings.apiKey;
                
                document.getElementById('modelInput').value = this.data.settings.model;
                document.getElementById('sysPromptInput').value = this.data.settings.sysPrompt;
                
                if(this.data.chats.length === 0) app.chat.new(false);
                else app.chat.load(this.data.chats[0].id);
                document.getElementById('userInput').addEventListener('keydown', (e) => {
                   if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); app.chat.send(); } 
                });
            },

            loadStorage() {
                const saved = localStorage.getItem('neurova_v7');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    this.data.chats = parsed.chats || [];
                    this.data.settings = {...this.data.settings, ...parsed.settings};
                }
            },
            saveStorage() {
                localStorage.setItem('neurova_v7', JSON.stringify({ chats: this.data.chats, settings: this.data.settings }));
            },

            chat: {
                new(render = true) {
                    const chat = { id: Date.now(), title: 'New Chat', messages: [] };
                    app.data.chats.unshift(chat);
                    if(render) this.load(chat.id);
                    app.ui.renderHistory();
                    app.saveStorage();
                },
                load(id) {
                    app.data.activeId = id;
                    const chat = app.data.chats.find(c => c.id == id);
                    const container = document.getElementById('chatContainer');
                    container.innerHTML = `<div id="welcome" class="${(!chat || chat.messages.length===0)?'flex':'hidden'} h-full flex-col items-center justify-center text-center"><h1 class="font-bold text-2xl">Ready?</h1></div>`;
                    if(chat) chat.messages.forEach(m => this.append(m));
                    app.ui.renderHistory();
                },
                append(msg) {
                    const container = document.getElementById('chatContainer');
                    const div = document.createElement('div');
                    div.className = `w-full flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
                    let attachHTML = '';
                    if(msg.attachments && msg.attachments.length) {
                         attachHTML = `<div class="flex gap-2 mb-2 flex-wrap justify-end">` + 
                            msg.attachments.map(u => `<img src="${u}" class="w-24 h-24 rounded-lg object-cover border border-gray-700">`).join('') + 
                            `</div>`;
                    }
                    const content = msg.role === 'user' ? msg.content : DOMPurify.sanitize(marked.parse(msg.content));
                    div.innerHTML = `<div class="max-w-[85%]">${attachHTML}<div class="${msg.role === 'user' ? 'bg-gray-100 dark:bg-gray-800 rounded-2xl px-4 py-2' : 'prose dark:prose-invert'}">${content}</div></div>`;
                    if(msg.role !== 'user') div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                },
                async send() {
                    const input = document.getElementById('userInput');
                    const text = input.value.trim();
                    const uploads = app.data.uploads;
                    if(!text && uploads.length === 0) return;
                    if(!app.data.settings.apiKey) { app.ui.toggleSettings(); return; }

                    input.value = '';
                    app.data.uploads = [];
                    app.ui.renderDock();
                    document.getElementById('welcome').classList.add('hidden');
                    const btn = document.getElementById('sendBtn');
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    const chat = app.data.chats.find(c => c.id == app.data.activeId);
                    const imgUrls = uploads.filter(u => u.type.startsWith('image')).map(u => u.content);
                    const userMsg = { role: 'user', content: text, attachments: imgUrls };
                    chat.messages.push(userMsg);
                    if(chat.messages.length === 1) chat.title = text.slice(0,20) || "Conversation";
                    this.append(userMsg);
                    app.saveStorage();

                    const payload = [{ role: 'system', content: app.data.settings.sysPrompt }];
                    chat.messages.forEach(m => {
                         if(m.attachments && m.attachments.length) {
                             payload.push({ role: m.role, content: [{ type: 'text', text: m.content }, ...m.attachments.map(u => ({ type: 'image_url', image_url: { url: u } }))] });
                         } else {
                             payload.push({ role: m.role, content: m.content });
                         }
                    });

                    try {
                        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${app.data.settings.apiKey}`, "Content-Type": "application/json" },
                            body: JSON.stringify({
                                model: app.data.webMode ? 'perplexity/sonar' : app.data.settings.model,
                                messages: payload
                            })
                        });

                        const json = await res.json();
                        if(json.error) throw new Error(json.error.message);
                        const aiText = json.choices[0].message.content;
                        const aiMsg = { role: 'assistant', content: aiText };
                        chat.messages.push(aiMsg);
                        this.append(aiMsg);
                        app.saveStorage();
                        if(aiText.includes('```html')) {
                             const code = aiText.match(/```html([\s\S]*?)```/)[1];
                             document.getElementById('canvasFrame').srcdoc = code;
                             app.ui.toggleCanvas(true);
                        }
                    } catch(e) { alert("Error: " + e.message); } 
                    finally { btn.innerHTML = '<i class="fa-solid fa-arrow-up text-sm"></i>'; }
                },
                toggleWeb() {
                    app.data.webMode = !app.data.webMode;
                    document.getElementById('webBtn').classList.toggle('text-green-500');
                }
            },
            files: {
                handle(input) {
                    Array.from(input.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            app.data.uploads.push({ type: file.type, content: e.target.result, name: file.name });
                            app.ui.renderDock();
                        };
                        reader.readAsDataURL(file);
                    });
                }
            },
            ui: {
                toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); },
                saveSettings() {
                    app.data.settings.apiKey = document.getElementById('apiKeyInput').value;
                    app.data.settings.model = document.getElementById('modelInput').value;
                    app.data.settings.sysPrompt = document.getElementById('sysPromptInput').value;
                    app.saveStorage();
                    app.sync.push(); // Push to Cloud!
                    this.toggleSettings();
                },
                toggleTheme() {
                    app.data.settings.theme = app.data.settings.theme === 'dark' ? 'light' : 'dark';
                    this.applyTheme();
                    app.saveStorage();
                },
                applyTheme() {
                    if(app.data.settings.theme === 'dark') document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                },
                renderHistory() {
                    const list = document.getElementById('chatList');
                    list.innerHTML = '';
                    app.data.chats.forEach(c => {
                        const div = document.createElement('div');
                        div.className = `p-2 rounded text-sm cursor-pointer truncate ${c.id === app.data.activeId ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-500' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`;
                        div.innerText = c.title;
                        div.onclick = () => app.chat.load(c.id);
                        list.appendChild(div);
                    });
                },
                renderDock() {
                    const dock = document.getElementById('previewDock');
                    dock.classList.toggle('hidden', app.data.uploads.length === 0);
                    dock.innerHTML = app.data.uploads.map(u => u.type.startsWith('image') ? `<img src="${u.content}" class="w-12 h-12 rounded object-cover border border-gray-600">` : `<div class="w-12 h-12 rounded bg-gray-800 flex items-center justify-center text-[8px] text-center border border-gray-600 overflow-hidden">${u.name}</div>`).join('');
                },
                toggleCanvas(show) {
                    const p = document.getElementById('canvasPanel');
                    p.parentElement.classList.toggle('canvas-open', show);
                }
            }
        };
        window.onload = () => app.auth.init();
    </script>
</body>
</html>
