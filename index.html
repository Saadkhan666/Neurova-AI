<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neurova AI | Design Restored</title>
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1a1d21', 900: '#111316', 950: '#0b0c0e' },
                        blue: { 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Base Reset */
        body { font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }
        
        /* Smooth Scrolling */
        .scroll-smooth { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        
        /* Message Styling */
        .prose pre { background: #0d1117 !important; border-radius: 8px; padding: 12px; border: 1px solid #30363d; }
        .msg-user { background-color: #f3f4f6; border-radius: 20px 20px 4px 20px; }
        .dark .msg-user { background-color: #1f2937; color: #f3f4f6; }
        .msg-ai { background: transparent; width: 100%; }
        
        /* Holo-Canvas Slide Animation */
        #canvasPanel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .canvas-open #canvasPanel { transform: translateX(0); }
        .canvas-closed #canvasPanel { transform: translateX(100%); }

        /* Loader Safety */
        #loader { transition: opacity 0.5s ease; pointer-events: none; }
    </style>
</head>
<body class="bg-white dark:bg-gray-950 text-gray-800 dark:text-gray-100 h-full flex transition-colors duration-300">

    <div id="loader" class="fixed inset-0 bg-white dark:bg-gray-950 z-[100] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-sm font-medium animate-pulse">Starting Neurova...</p>
        <button onclick="document.getElementById('loader').style.opacity='0'; setTimeout(()=>document.getElementById('loader').remove(),500)" class="mt-6 text-xs text-gray-400 underline cursor-pointer">Stuck? Click to Skip</button>
    </div>

    <aside id="sidebar" class="w-64 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col hidden md:flex shrink-0">
        <div class="p-4 h-16 flex items-center gap-2 font-bold text-lg border-b border-gray-200 dark:border-gray-800">
            <span class="text-blue-600"><i class="fa-solid fa-brain"></i></span> Neurova
        </div>
        
        <div class="p-3">
            <button onclick="app.newChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-2 text-sm font-medium transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> New Chat
            </button>
        </div>

        <div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-1">
            </div>

        <div class="p-4 border-t border-gray-200 dark:border-gray-800 text-xs text-gray-500 flex justify-between items-center">
            <button onclick="app.toggleSettings()" class="hover:text-blue-500"><i class="fa-solid fa-cog"></i> Settings</button>
            <button onclick="app.toggleTheme()" class="hover:text-blue-500"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative min-w-0">
        
        <header class="md:hidden h-14 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 bg-white/80 dark:bg-gray-950/80 backdrop-blur sticky top-0 z-20">
            <div class="font-bold flex items-center gap-2">
                <i class="fa-solid fa-brain text-blue-600"></i> Neurova
            </div>
            <button onclick="app.toggleMobileMenu()" class="text-gray-500"><i class="fa-solid fa-bars"></i></button>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
            <div id="welcome" class="h-full flex flex-col items-center justify-center text-center opacity-100 transition-opacity duration-500">
                <div class="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mb-6 shadow-xl text-white text-2xl">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">How can I help you?</h1>
                <p class="text-gray-400 max-w-sm text-sm">I can write code, analyze images, and search the web.</p>
            </div>
            </div>

        <div class="p-4 bg-white dark:bg-gray-950 z-20">
            <div class="max-w-3xl mx-auto relative group">
                <div id="previewArea" class="hidden absolute -top-16 left-0 flex gap-2 p-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg shadow-lg"></div>

                <textarea id="userInput" rows="1" class="w-full bg-gray-100 dark:bg-gray-900 border-0 rounded-2xl pl-4 pr-32 py-4 focus:ring-2 focus:ring-blue-500 resize-none shadow-sm text-base" placeholder="Ask anything..."></textarea>
                
                <div class="absolute right-2 bottom-2.5 flex items-center gap-1">
                    <button id="webBtn" onclick="app.toggleWeb()" class="p-2 text-gray-400 hover:text-green-500 rounded-full transition" title="Search Web">
                        <i class="fa-solid fa-globe"></i>
                    </button>
                    <button onclick="document.getElementById('fileUpload').click()" class="p-2 text-gray-400 hover:text-blue-500 rounded-full transition" title="Upload Image">
                        <i class="fa-solid fa-paperclip"></i>
                    </button>
                    <input type="file" id="fileUpload" class="hidden" accept="image/*" onchange="app.handleImage(this)">
                    
                    <button onclick="app.send()" id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl w-9 h-9 flex items-center justify-center transition disabled:opacity-50">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
            <div class="text-center mt-2 text-[10px] text-gray-400">
                <span id="modelLabel">Using: DeepSeek R1 (Free)</span>
            </div>
        </div>
    </main>

    <aside id="canvasPanel" class="fixed inset-y-0 right-0 w-full md:w-[45%] bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 shadow-2xl z-40 transform translate-x-full flex flex-col">
        <div class="h-14 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 bg-gray-50 dark:bg-gray-900">
            <span class="font-bold text-sm text-blue-600 uppercase tracking-wider"><i class="fa-solid fa-code"></i> Holo-Canvas</span>
            <div class="flex gap-2">
                <button onclick="app.downloadCanvas()" class="p-2 text-gray-500 hover:text-green-500"><i class="fa-solid fa-download"></i></button>
                <button onclick="app.toggleCanvas(false)" class="p-2 text-gray-500 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>
        <div class="flex-1 bg-gray-100 dark:bg-black relative">
            <iframe id="canvasFrame" class="w-full h-full border-none"></iframe>
            <div id="canvasPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                <i class="fa-solid fa-cube fa-2x mb-2"></i>
                <p class="text-sm">Generate code to see preview</p>
            </div>
        </div>
    </aside>

    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform">
            <h2 class="text-xl font-bold mb-4">Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">OpenRouter API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Model Name</label>
                    <input type="text" id="modelInput" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-lg px-3 py-2 text-sm" value="deepseek/deepseek-r1:free">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">System Instructions</label>
                    <textarea id="sysPromptInput" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-lg px-3 py-2 text-sm h-24" placeholder="You are a helpful assistant..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button>
                <button onclick="app.saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').remove(), 500);
            }, 800);
            app.init();
        });

        const app = {
            data: {
                chats: [],
                activeId: null,
                settings: {
                    apiKey: '',
                    model: 'deepseek/deepseek-r1:free',
                    sysPrompt: 'You are Neurova. If asked to write HTML/CSS, provide the full code.',
                    theme: 'dark'
                },
                webMode: false,
                attachments: [] // Base64
            },

            init() {
                try {
                    // Load LocalStorage
                    const saved = localStorage.getItem('neurova_v3');
                    if(saved) {
                        const parsed = JSON.parse(saved);
                        this.data.chats = parsed.chats || [];
                        this.data.settings = {...this.data.settings, ...parsed.settings};
                    }
                    
                    // Apply Settings
                    this.applyTheme();
                    document.getElementById('apiKeyInput').value = this.data.settings.apiKey;
                    document.getElementById('modelInput').value = this.data.settings.model;
                    document.getElementById('sysPromptInput').value = this.data.settings.sysPrompt;
                    
                    // Setup Chat
                    if(this.data.chats.length === 0) this.newChat(false);
                    else this.loadChat(this.data.chats[0].id);
                    
                    this.renderHistory();
                    
                    // Event Listeners
                    document.getElementById('userInput').addEventListener('keydown', (e) => {
                        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.send(); }
                    });

                } catch(e) { console.error("Init Error", e); }
            },

            save() {
                localStorage.setItem('neurova_v3', JSON.stringify({
                    chats: this.data.chats,
                    settings: this.data.settings
                }));
            },

            // --- UI ACTIONS ---
            toggleTheme() {
                this.data.settings.theme = this.data.settings.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.save();
            },

            applyTheme() {
                const html = document.documentElement;
                if(this.data.settings.theme === 'dark') {
                    html.classList.add('dark');
                    document.getElementById('themeIcon').className = 'fa-solid fa-sun';
                } else {
                    html.classList.remove('dark');
                    document.getElementById('themeIcon').className = 'fa-solid fa-moon';
                }
            },

            toggleSettings() {
                document.getElementById('settingsModal').classList.toggle('hidden');
            },

            saveSettings() {
                this.data.settings.apiKey = document.getElementById('apiKeyInput').value.trim();
                this.data.settings.model = document.getElementById('modelInput').value.trim();
                this.data.settings.sysPrompt = document.getElementById('sysPromptInput').value;
                this.save();
                this.toggleSettings();
                document.getElementById('modelLabel').innerText = `Using: ${this.data.settings.model}`;
            },

            toggleWeb() {
                this.data.webMode = !this.data.webMode;
                const btn = document.getElementById('webBtn');
                if(this.data.webMode) {
                    btn.classList.add('text-green-500', 'bg-green-100', 'dark:bg-green-900/20');
                    document.getElementById('modelLabel').innerText = "Web Search: ON (Perplexity/Sonar)";
                } else {
                    btn.className = "p-2 text-gray-400 hover:text-green-500 rounded-full transition";
                    document.getElementById('modelLabel').innerText = `Using: ${this.data.settings.model}`;
                }
            },

            toggleCanvas(show) {
                const panel = document.getElementById('canvasPanel');
                if(show) {
                    panel.parentElement.classList.add('canvas-open');
                    document.body.classList.add('canvas-open');
                } else {
                    panel.parentElement.classList.remove('canvas-open');
                    document.body.classList.remove('canvas-open');
                }
            },

            handleImage(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.data.attachments.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = "w-10 h-10 rounded border object-cover";
                    const area = document.getElementById('previewArea');
                    area.classList.remove('hidden');
                    area.appendChild(img);
                };
                reader.readAsDataURL(file);
            },

            // --- CHAT LOGIC ---
            newChat(render = true) {
                const chat = { id: Date.now(), title: 'New Chat', messages: [] };
                this.data.chats.unshift(chat);
                if(render) this.loadChat(chat.id);
                this.renderHistory();
                this.save();
            },

            loadChat(id) {
                this.data.activeId = id;
                const chat = this.data.chats.find(c => c.id == id);
                const container = document.getElementById('chatContainer');
                
                // Keep welcome only if empty
                if(!chat || chat.messages.length === 0) {
                    document.getElementById('welcome').style.opacity = '1';
                    document.getElementById('welcome').style.display = 'flex';
                    // Clear other messages
                    Array.from(container.children).forEach(child => {
                        if(child.id !== 'welcome') child.remove();
                    });
                } else {
                    document.getElementById('welcome').style.opacity = '0';
                    document.getElementById('welcome').style.display = 'none';
                    // Clear and Rebuild
                    container.innerHTML = `<div id="welcome" class="hidden"></div>`;
                    chat.messages.forEach(msg => this.appendMessage(msg));
                }
                this.renderHistory();
            },

            renderHistory() {
                const list = document.getElementById('chatList');
                if(!list) return;
                list.innerHTML = '';
                this.data.chats.forEach(c => {
                    const div = document.createElement('div');
                    const active = c.id == this.data.activeId;
                    div.className = `p-2 rounded cursor-pointer text-sm truncate ${active ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`;
                    div.innerText = c.title;
                    div.onclick = () => this.loadChat(c.id);
                    list.appendChild(div);
                });
            },

            appendMessage(msg, isStream = false) {
                const container = document.getElementById('chatContainer');
                let div = isStream ? document.getElementById('streamingMsg') : document.createElement('div');
                
                if(!div) {
                    div = document.createElement('div');
                    if(isStream) div.id = 'streamingMsg';
                    div.className = `w-full flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                    container.appendChild(div);
                }

                // Attachments
                let imgHTML = '';
                if(msg.attachments && msg.attachments.length) {
                    imgHTML = `<div class="flex gap-2 mb-2 justify-end">`;
                    msg.attachments.forEach(url => imgHTML += `<img src="${url}" class="max-w-[150px] rounded-lg border">`);
                    imgHTML += `</div>`;
                }

                const contentClass = msg.role === 'user' ? 'msg-user px-4 py-3 text-sm' : 'msg-ai prose dark:prose-invert text-sm max-w-none';
                
                let htmlContent = msg.role === 'user' ? msg.content : DOMPurify.sanitize(marked.parse(msg.content));
                
                div.innerHTML = `
                    <div class="max-w-[90%] md:max-w-[80%] ${msg.role === 'user' ? 'ml-auto' : ''}">
                        ${imgHTML}
                        <div class="${contentClass}">
                            ${htmlContent}
                        </div>
                    </div>
                `;

                // Highlight code
                if(msg.role !== 'user') {
                    div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                }

                container.scrollTop = container.scrollHeight;
            },

            async send() {
                const input = document.getElementById('userInput');
                const text = input.value.trim();
                const attachments = [...this.data.attachments];
                
                if(!text && attachments.length === 0) return;
                if(!this.data.settings.apiKey) { this.toggleSettings(); return; }

                // Clear UI
                input.value = '';
                this.data.attachments = [];
                document.getElementById('previewArea').innerHTML = '';
                document.getElementById('previewArea').classList.add('hidden');
                document.getElementById('welcome').style.display = 'none';

                // Save User Msg
                const chat = this.data.chats.find(c => c.id == this.data.activeId);
                const userMsg = { role: 'user', content: text, attachments: attachments };
                chat.messages.push(userMsg);
                if(chat.messages.length === 1) chat.title = text.slice(0, 20) || "New Conversation";
                
                this.save();
                this.appendMessage(userMsg);

                // Prepare Stream
                const msgs = chat.messages.map(m => {
                    if(m.attachments && m.attachments.length) {
                        return {
                            role: m.role,
                            content: [
                                {type: "text", text: m.content},
                                ...m.attachments.map(a => ({type: "image_url", image_url: {url: a}}))
                            ]
                        };
                    }
                    return {role: m.role, content: m.content};
                });

                // Insert System Prompt
                msgs.unshift({ role: "system", content: this.data.settings.sysPrompt });

                const model = this.data.webMode ? 'perplexity/sonar' : this.data.settings.model;

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${this.data.settings.apiKey}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href,
                        },
                        body: JSON.stringify({ model, messages: msgs, stream: true })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = "";

                    // Streaming UI Placeholder
                    this.appendMessage({role: 'assistant', content: '<span class="animate-pulse">...</span>'}, true);

                    while(true) {
                        const {done, value} = await reader.read();
                        if(done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for(const line of lines) {
                            if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(line.slice(6));
                                    const content = json.choices[0]?.delta?.content || "";
                                    fullText += content;
                                    this.appendMessage({role: 'assistant', content: fullText}, true);
                                } catch(e) {}
                            }
                        }
                    }

                    // Remove stream ID
                    document.getElementById('streamingMsg').removeAttribute('id');
                    
                    // Save Assistant Msg
                    chat.messages.push({ role: 'assistant', content: fullText });
                    this.save();
                    this.renderHistory();

                    // Check for Canvas Code
                    this.checkForCanvas(fullText);

                } catch(e) {
                    this.appendMessage({role: 'assistant', content: `**Error:** ${e.message}`});
                }
            },

            checkForCanvas(text) {
                // Simple regex to find HTML code blocks
                const htmlMatch = text.match(/```html([\s\S]*?)```/);
                if(htmlMatch) {
                    const code = htmlMatch[1];
                    const frame = document.getElementById('canvasFrame');
                    frame.srcdoc = code;
                    document.getElementById('canvasPlaceholder').style.display = 'none';
                    this.toggleCanvas(true);
                }
            },
            
            downloadCanvas() {
                const frame = document.getElementById('canvasFrame');
                const blob = new Blob([frame.srcdoc], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'neurova_canvas.html';
                a.click();
            }
        };
    </script>
</body>
</html>
